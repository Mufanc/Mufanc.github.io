<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Qlivoid 与网课挂机 | 星河璀璨丶凡尘點點</title><meta name="author" content="Mufanc"><meta name="copyright" content="Mufanc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="高中阶段最后的疯狂，耗时一个月，开发名为 Qlivoid 的网课全自动挂机脚本">
<meta property="og:type" content="article">
<meta property="og:title" content="Qlivoid 与网课挂机">
<meta property="og:url" content="https://blog.mufanc.xyz/posts/25707/index.html">
<meta property="og:site_name" content="星河璀璨丶凡尘點點">
<meta property="og:description" content="高中阶段最后的疯狂，耗时一个月，开发名为 Qlivoid 的网课全自动挂机脚本">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.mufanc.xyz/assets/images/top_img.webp">
<meta property="article:published_time" content="2020-11-09T17:28:53.000Z">
<meta property="article:modified_time" content="2022-09-21T14:33:21.638Z">
<meta property="article:author" content="Mufanc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.mufanc.xyz/assets/images/top_img.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://blog.mufanc.xyz/posts/25707/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/images/icon.png"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/images/icon.png"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":120,"position":"top","messagePrev":"这篇文章距离上次更新已经超过","messageNext":"天，其内容可能已过时"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Qlivoid 与网课挂机',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-21 22:33:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/assets/styles/customize.css"><link rel="stylesheet" href="/assets/styles/404.css"><script src="/assets/js/jquery-3.6.0.min.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="星河璀璨丶凡尘點點" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/images/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-book-bookmark"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-user-group"></i><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/assets/images/top_img.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">星河璀璨丶凡尘點點</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-book-bookmark"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-user-group"></i><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Qlivoid 与网课挂机</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-09T17:28:53.000Z" title="发表于 2020-11-10 01:28:53">2020-11-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-21T14:33:21.638Z" title="更新于 2022-09-21 22:33:21">2022-09-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E3%80%8C%E6%97%A7%E8%92%99%E5%BE%B7%E3%80%8D/">「旧蒙德」</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Qlivoid 与网课挂机"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/25707/#post-comment"><span id="twikoo-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><html><head></head><body><div class="note info simple"><p>  高中的中二作品 <s>（开发流水帐）</s>，放到这边权当留档纪念，当时技术有限，代码实现难免有不优雅之处，还请各位看官一笑了之 ੭ ᐕ)੭*⁾⁾   <s>新一代自动化工具 <a target="_blank" rel="noopener" href="http://Auto.py">Auto.py</a> 也在加紧开发中，应该马上就能在我的 GitHub 仓库中看到啦</s></p>
</div>
<p>  新冠疫情的降临，直接将高三的寒假从一周延长到了三个月，天天听网课确实是过于枯燥，不如研发个自动挂机脚本出来玩玩……脚本挂机下的网课，直接趴桌子睡觉不再是梦</p>
<p>  这其实是个早就完成了的项目，开发记录全都丢在石墨文档，如今既然搭建了自己的博客，就索性把石墨那边的文档陆续往这搬，顺便搞一下排版优化</p>
<p>  整理过程中，看到自己曾经的笔调写下的文档，想起了那段紧张又快乐的时光，果然还是会有些怀念啊……</p>
<h2 id="写在前面">写在前面</h2>
<p><strong>2020 年 3 月 9 日，周一</strong></p>
<p>  首先说一下关于 Qlivoid 名字的由来:</p>
<p><img src="Qlivoid%E7%94%B1%E6%9D%A5.png" alt=""></p>
<p>  由于 Qlivoid 项目在我开始使用石墨文档之前就已经在做了，所以整个开发过程将以文档创建日期为分界做两种形式的记录。文档创建之前的内容记录主要以 QQ 空间的记录+回忆为依据编写，可能不能详细地还原出每个bug的出现时间和具体情况，文档创建之后的记录将用各种形式更加详细地记录出现的问题以及出现时间以及解决方案。</p>
<p>  根据年级的安排来看，可能在 Qlivoid 尚未完善到最终版之前就已经正式开学，无法将一个项目完美的完成还是有些遗憾哈，不过姑且也是一次很有意义的练习和提升机会，就算明知道无法完成，也还是把它做好吧<font size="2">（其实最后还是做完了）</font></p>
<hr>
<h2 id="回忆部分">回忆部分</h2>
<h3 id="2-月-16-日-开端">2 月 16 日 开端</h3>
<p><img src="%E8%AF%BE%E7%A8%8B%E8%A1%A8.png" alt=""></p>
<p>  智学网挂机脚本刚刚推出稳定版不到一周，就给我整这种幺蛾子，没办法，课依然不想听，挂机依然要挂，只能开始 QQ 挂机脚本项目（当时还不叫 Qlivoid）</p>
<h3 id="2-月-20-日-雏形">2 月 20 日 雏形</h3>
<p>  脚本已经基本完成了，引用了 Jsp 模块，支持上课自动跳转，进入课堂发送消息打卡，复读机，检测问卷星链接并启动悬浮窗进行打卡，代码体量也已经达到了 472 行，能够满足一定程度的挂机需求，但依然不放心让它自己在那挂着，还有很多地方需要改进。</p>
<h3 id="2-月-28-日-更新">2 月 28 日 更新</h3>
<p>  在研究每日健康汇报 WPS 表单自动填写的时候，偶然发现能够通过对问卷星的打卡网页进行 JavaScript 注入来完成打卡，可以免去使用无障碍服务，同时有效避免了签到时悬浮窗遮挡聊天界面的问题，在一定程度上提升了脚本的稳定性，但同时也带来了新的问题，Auto.js Pro v7.0.4 中无法正常使用 JavaAdapter 实现类的实例化，所以临时赶工了一个 Socket 脚本来实现 Pro 版与免费版 Auto.js 之间的的通信，具体的流程是使用 Auto.js 免费版创建一个 Socket Server 等待挂机脚本发送的包含问卷星链接的连接请求（这个 Server 依然不稳定，即使使用 <code>try...catch...</code> 进行异常处理，依然有时候在重启 Qlivoid 时会因为不明原因自动停止，不过貌似在 Qlivoid 运行期间表现正常？注释于 3 月 9 日)</p>
<p>  修复了下课后不能正常退出的问题（这个指的是模拟点击下课按钮失败，因判断下课逻辑错误而不能正常退出通话的问题在 3 月 7 日得到修复）</p>
<p>  修复了有时候已经上课却找不到课程的问题（怎么修复的忘了）；修复了下课之后不能正常退出的问题（指点击「挂断」按钮失败的问题，判断是否下课的逻辑并无错误）通过重写 GetName 函数，修复了找不到聊天记录的问题。脚本体量扩展到 642 行，整体的稳定性有了较大提升。</p>
<h3 id="2-月-29-日-更新">2 月 29 日 更新</h3>
<p>  新增 检测聊天内容决定是否退出通话，逻辑为下课时间到后等待「谢谢老师」出现时退出通话，且最多等待 10 分钟。</p>
<p>  将 Jsp 模块中的部分代码移植到脚本中，取消对 Jsp 模块的引用，使脚本整体集成到单文件（除了免费版那边的 Server，这个没办法搞<font color="gray" size="2">貌似可以用Intent?</font>）</p>
<p>  项目正式更名为 Qlivoid，新增日志输出到文件，且日志内容包括输出该条日志代码的行号，方便后续调试。</p>
<h3 id="3-月-3-日-更新">3 月 3 日 更新</h3>
<p>  新增 检测到以 <code>|;</code> 或 <code>#;</code>（分号中英文无所谓），结尾的聊天记录时长震动并发出语音警报提醒<br>
  新增 英语课群签到打卡功能，同样为检测聊天记录决定行为，这里为了偷懒不想判断签到的 View，用了 QNotified 模块中的签到文本化功能将所有打卡消息转变为 <code>[群签到]群签到</code>（这样就能嵌入到聊天消息记录模块中🌶️）</p>
<p>  修复有时候自动退出课堂失败的问题（具体问题不记得了，跟 2.28 修复的退课失败原因不同）</p>
<h3 id="3-月-5-日-大更新">3 月 5 日 大更新</h3>
<p>  现在复读时会调用 TTS 语音引擎（小米系统内置一个小爱 TTS 引擎，挺好的）朗读复读内容，进群随机发送消息改为随机发送消息或进行群签到，消息内容简单化</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可选消息列表，#Sign# 表示群签到</span></span><br><span class="line">[<span class="string">'1'</span>, <span class="string">'#Sign#'</span>, <span class="string">'#Sign#'</span>, <span class="string">':1'</span>, <span class="string">'#Sign#'</span>, <span class="string">'1'</span>, <span class="string">'壹'</span>, <span class="string">'1'</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>  Qlivoid 会自动通过群名称判断当前在上的课程，并自动修复所在群与应在群不同的情况（找不到所在群时跳转到应在群，所在群和应在群不同时将应在群设置为所在群）</p>
<p>  新增对于群签到打卡是否成功的检测，若失败则再次尝试打卡，尝试次数上限定为 3</p>
<p>  修复由于之前写代码的时候脑抽，忘了判断消息是否为自己发送，以及没有给群签到打卡设定冷却时间，导致的无限打卡的问题</p>
<p>  修复了由于正则表达式少写一个 <code>:</code> 导致的日志显示行数错误的问题。</p>
<p>  新增对聊天界面系统通知气泡的检测，在 QQ 抽风或因网络故障进不去直播时发出警告并自动重启 QQ</p>
<p>  由于发现将日志输出到文件会拖慢脚本循环的速度，去除了这一功能。</p>
<h3 id="3-月-7-日-更新">3 月 7 日 更新</h3>
<p><img src="%E5%8D%B11.png" alt="翻车现场#1"></p>
<p><img src="%E5%8D%B12.png" alt="翻车现场#2"></p>
<p>  由于 3 月 6 日（你们怎么不发「谢谢老师」啊喂）和 3 月 7 日（奶奶滴，谁知道写作文还要退出语音的？？）语文课上翻车，现将下课后对“谢谢老师”的最长等待时间改为 5 分钟，且若下课前 5 min 内出现“谢谢老师”，则认为提前下课，脚本退出课堂</p>
<p>  将语文课列为重点关注课堂，所有获取到的聊天记录将以语音形式播出，同时如果消息内容中出现预设的“重点关注”词汇，会进一步触发震动提醒</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重点关注词汇: ['退', '重新', '重进', '语音', '全体']</span></span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="正式记录">正式记录</h2>
<h3 id="需要注意的几点">需要注意的几点</h3>
<p>  网课情况复杂多变，需要考虑一些极端情况（比如在任何时刻通话都有可能被迫关闭，脚本应该有能够处理这些异常的能力），同时为了适应错综复杂的情况，脚本不能仅凭设备本地的设定做出行动，一定要能够从集体的行为中获取信息。</p>
<p>  关闭权限后，会出现某些特殊 Dialog，需要在脚本中实现处理</p>
<h4 id="悬浮窗权限未能获取">悬浮窗权限未能获取</h4>
<center><font size="3">出现在刚刚从<b>语音通话/屏幕分享</b>界面退出时:</font></center>
<p><img src="%E5%B1%8F%E5%B9%95%E5%88%86%E4%BA%AB-%E6%82%AC%E6%B5%AE%E7%AA%97%E6%9D%83%E9%99%90.png" alt=""></p>
<center><font size="3">出现在即将进入<b>群视频</b>时:</font></center>
<p><img src="%E7%BE%A4%E8%A7%86%E9%A2%91-%E6%82%AC%E6%B5%AE%E7%AA%97%E6%9D%83%E9%99%90.png" alt=""></p>
<center>为了避免偶然状况，<b>任何时候</b>都应具备处理此类 Dialog 的能力</center>
<h4 id="提示加入通话">提示加入通话</h4>
<center><font size="3">出现在未设置消息免打扰的群发起通话时:</font></center>
<p><img src="%E9%80%9A%E8%AF%9D%E6%8F%90%E9%86%92.png" alt=""></p>
<center>解决方案：暂时设置班群消息免打扰</center>
<h4 id="提示添加快捷方式">提示添加快捷方式</h4>
<center><font size="3">出现在进入群视频之前:</font></center>
<p><img src="%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E6%B7%BB%E5%8A%A0%E6%8F%90%E9%86%92.png" alt=""></p>
<center>解决方案：点击确定后似乎没有再提示过这个</center>
<h4 id="提示通话冲突">提示通话冲突</h4>
<center><font size="3">出现在已在通话但即将加入另一通话时:</font></center>
<p><img src="%E9%80%9A%E8%AF%9D%E5%86%B2%E7%AA%81.png" alt=""></p>
<center>解决方法：将点击「<b>继续</b>」的优先级设置在选择「<b>取消</b>」或「<b>忽略</b>」之上</center>
<h4 id="提示悬浮窗打开失败">提示悬浮窗打开失败</h4>
<center><font size="3">出现在提示打开悬浮窗权限后切换页面而仍没有悬浮窗权限:</font></center>
<p><img src="%E6%82%AC%E6%B5%AE%E7%AA%97%E6%89%93%E5%BC%80%E5%A4%B1%E8%B4%A5%E6%8F%90%E9%86%92.png" alt=""></p>
<h4 id="群公告">群公告</h4>
<center>解决方法：模拟点击「<b>我知道了</b>」</center>
<br>
<p>  于是创建一个<code>cancel</code>函数，用于处理各种dialog事件：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cancel</span>(<span class="params"></span>) </span>{  <span class="comment">// 处理偶然弹出的dialog</span></span><br><span class="line">    click(<span class="string">'继续'</span>) || click(<span class="string">'取消'</span>) || click(<span class="string">'忽略'</span>) || click(<span class="string">'稍后处理'</span>) || click(<span class="string">'我知道了'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="一些奇技淫巧">一些奇技淫巧</h3>
<ul>
<li>使 Auto.js 的日志输出内容包括打印日志的行：</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> methods = [<span class="string">'verbose'</span>, <span class="string">'log'</span>, <span class="string">'info'</span>, <span class="string">'warn'</span>, <span class="string">'error'</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; methods.length; i++) {</span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params">meth</span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> origin = <span class="built_in">console</span>[meth];</span><br><span class="line">        <span class="built_in">console</span>[meth] = <span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>{</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                $_$;  <span class="comment">// 故意制造一个错误，得到报错的行</span></span><br><span class="line">            } <span class="keyword">catch</span>(e) {</span><br><span class="line">                <span class="keyword">var</span> st = e.stack;</span><br><span class="line">                st = st.split(<span class="string">'\n'</span>)[<span class="number">1</span>].match(<span class="regexp">/\t.+:(\d+)/</span>)[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> out = <span class="string">'Line['</span> + st + <span class="string">']: '</span> + s;</span><br><span class="line">                origin(out);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    })(methods[i]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>在主循环中拦截错误并显示行数：</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {  <span class="comment">// 主循环</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// Do something...</span></span><br><span class="line">    } <span class="keyword">catch</span>(e) {</span><br><span class="line">        <span class="keyword">var</span> line = e.stack.split(<span class="string">'\n'</span>)[<span class="number">0</span>].match(<span class="regexp">/\t.+:(\d+)/</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">'错误拦截: At line:'</span> + line + <span class="string">' '</span> + e);</span><br><span class="line">    }</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>脚本暂停函数（其实就是个死循环）</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pause</span>(<span class="params"></span>) </span>{  <span class="comment">// 暂停</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-月-9-日">3 月 9 日</h3>
<p>  从今天起，语文课的直播换用<strong>群课堂</strong>进行，其实是件好事情（起码不聋了），对于群课堂的支持早在项目初期英语课使用群视频直播时便已完成，只需稍加优化即可投入使用，但再三考虑之后，还是决定将原来用于挂机的 Redmi 6A 更换为 LeEco Le X625，主要基于如下考虑：</p>
<ul>
<li>
<p>换用的新设备有 Root 权限，启动 Activity 或者模拟点击、调用 shell 命令都更加方便<font size="3" color="gray">(其实并不方便，注释于 3.10)</font></p>
</li>
<li>
<p>新设备安装有Xposed框架，某些功能能帮助节省代码量</p>
</li>
<li>
<p>新设备掉电快，拿着也要一直充电才能用，不如用来挂机</p>
</li>
<li>
<p>貌似新设备更流畅？</p>
</li>
</ul>
<p>  当然同时也带来了几个问题，其中之一便是换机之后大部分的代码都需要重构，因为两台机器的型号和 Android 版本不同，QQ 显示的界面也就会有所差异。重构之后的代码将彻底取消对于 Jsp 模块的引用以及与免费版的 Socket 通信，只为提升速度和稳定性。</p>
<p>  今天的物理课（TM 怎么连续几天出问题）上又发现了新的问题，当在非下课时间，使用「屏幕分享」的其它成员退出后，自己不能检测到并退出。现发现当通话成员只剩一人时，悬浮通话按钮上的文字会变为“<strong>等待中</strong>”，可以通过检测改按钮的状态来判断人数情况，然鹅这并不是一个很好的办法（老师不退出或者还有别的大聪明在的时候容易翻车），希望能够找到一种既能记录聊天内容，又能实时统计通话人数的方案（轮询感觉不太好，容易错过聊天记录）。</p>
<p>  几小时后…</p>
<p>  忽然发现了一种较好的解决方案：将 QQ 的悬浮窗权限禁止之后加入通话，标题栏中就会出现人数显示。</p>
<h4 id="QQ电话、屏幕分享">QQ电话、屏幕分享</h4>
<p>  自己未加入时：</p>
<p><img src="%E8%87%AA%E5%B7%B1%E6%9C%AA%E5%8A%A0%E5%85%A5%E6%97%B6.png" alt=""></p>
<p>  自己加入后：</p>
<p><img src="%E8%87%AA%E5%B7%B1%E5%8A%A0%E5%85%A5%E5%90%8E.png" alt=""></p>
<p>  只剩自己一人时：</p>
<p><img src="%E5%8F%AA%E5%89%A9%E8%87%AA%E5%B7%B1%E4%B8%80%E4%BA%BA%E6%97%B6.png" alt=""></p>
<h4 id="群视频、群课堂">群视频、群课堂</h4>
<p>  自己未加入时：</p>
<p><img src="%E8%87%AA%E5%B7%B1%E6%9C%AA%E5%8A%A0%E5%85%A5%E6%97%B62.png" alt=""></p>
<p>  自己加入后（Intent跳转回聊天页面卡出「僵尸状态」）：</p>
<p><img src="%E8%87%AA%E5%B7%B1%E5%8A%A0%E5%85%A5%E5%90%8E2.png" alt=""></p>
<center>无论自己是否加入，都是显示人数</center>
<p>  群视频不能没有主持人，所以不会出现只剩自己一人的情况</p>
<h4 id="特殊情况">特殊情况</h4>
<p>  当群视频和语音通话同时存在时</p>
<p><img src="%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5.png" alt=""></p>
<center>无论自己是否加入，都是显示人数</center>
<p>  可以根据这些信息整理出一个获取课堂在线人数的函数：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回课堂成员数量 &amp; 修正课程类型 &amp; 修正在看课程</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMemberCount</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> title = textMatches(<span class="regexp">/语音通话中 \(\d+人\)/</span>).findOnce();</span><br><span class="line">    <span class="keyword">if</span> (title) {</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">    }</span><br><span class="line">    title = textMatches(<span class="regexp">/\d+人正在语音通话/</span>).findOnce();</span><br><span class="line">    <span class="keyword">if</span> (title) {</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">    }</span><br><span class="line">    title = text(<span class="string">'等待其他成员加入...'</span>).findOnce();</span><br><span class="line">    <span class="keyword">if</span> (title) {</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    title = textMatches(<span class="regexp">/\d+人正在视频聊天/</span>).findOnce();</span><br><span class="line">    <span class="keyword">if</span> (title) {</span><br><span class="line">        type = <span class="string">'live'</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">    }</span><br><span class="line">    title = textMatches(<span class="regexp">/\d+人正在通话/</span>).findOnce();</span><br><span class="line">    <span class="keyword">if</span> (title) {</span><br><span class="line">        type = <span class="string">'live'</span>;  <span class="comment">// 两种方式同时存在时，优先相信群视频</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  接下来分析脚本的运行逻辑，先简单整理一下大框架：</p>
<p><img src="%E9%80%BB%E8%BE%91%E6%A1%86%E6%9E%B6.png" alt=""></p>
<p>  由于脚本使用的基本时间单位为<strong>分钟</strong>，所以先写一个获取时间的函数：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTime</span>(<span class="params"></span>) </span>{  <span class="comment">// 获取一天中已过的分钟数</span></span><br><span class="line">    <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">return</span> date.getHours()*<span class="number">60</span> + date.getMinutes();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  框架逻辑采用时间驱动行为，在不同的时间决定做不同的事情，所以首先需要制作一张课程时刻表：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上下课时间，整数部分为小时，小数部分为分</span></span><br><span class="line"><span class="keyword">var</span> stime = [<span class="number">7.55</span>, <span class="number">9.05</span>, <span class="number">10.15</span>, <span class="number">14.25</span>, <span class="number">15.35</span>, <span class="number">16.45</span>];</span><br><span class="line"><span class="keyword">var</span> etime = [<span class="number">8.45</span>, <span class="number">9.55</span>, <span class="number">11.05</span>, <span class="number">15.15</span>, <span class="number">16.25</span>, <span class="number">17.35</span>];</span><br><span class="line"><span class="keyword">var</span> schedule = [];</span><br><span class="line"><span class="comment">// 把时间格式转换为脚本的通用表示方法</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; stime.length; i++) {  </span><br><span class="line">    schedule.push([</span><br><span class="line">        stime[i]*<span class="number">60</span>+(stime[i]-(stime[i]|<span class="number">0</span>))*<span class="number">40</span>,</span><br><span class="line">        etime[i]*<span class="number">60</span>+(etime[i]-(etime[i]|<span class="number">0</span>))*<span class="number">40</span></span><br><span class="line">    ]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  然后需要一张课程表：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 各个科目上课的群，按照课程顺序(数语英自化物生)排列群号</span></span><br><span class="line"><span class="keyword">var</span> classes = [</span><br><span class="line">  <span class="string">'103026***9'</span>, <span class="string">'105673***1'</span>, <span class="string">'98150***2'</span>, <span class="string">'82286***7'</span>, <span class="string">'82286***7'</span>,  <span class="string">'105367***6'</span></span><br><span class="line">];</span><br></pre></td></tr></tbody></table></figure>
<p>  再定义一个函数来获取当前应上的课程序号，不在上课时间则返回-1：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldInWhat</span>(<span class="params">time</span>) </span>{</span><br><span class="line">    should = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; schedule.length; i++) {</span><br><span class="line">        <span class="keyword">if</span> (schedule[i][<span class="number">0</span>] &lt;= time &amp;&amp; time &lt; schedule[i][<span class="number">1</span>]) {</span><br><span class="line">            should = i;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> should;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>然后处理复杂的课内逻辑：</strong></p>
<p>  也许是因为<strong>屏幕分享</strong>使用的是通话音量的缘故，禁用 QQ 麦克风权限后上课会成为聋子，<s>都已经是盲人了，聋不聋还有意义吗？</s> 听不到老师的声音就容易翻车，所以需要通过 TTS 朗读聊天内容来作为辅助。</p>
<p>  看来今天是写不完了，以后再补充吧…</p>
<h3 id="3-月-10-日">3 月 10 日</h3>
<p>  发现乐视手机的 RootAutomator 存在模拟手势失败的情况，从安全角度考虑，今晚先去找找有没有 Android 7.0 以上的 ROM 刷入，是在不行就只能换回红米来挂机了。</p>
<p>  先到 ROM乐园<font size="3" color="gray">（无法想象当时我怎么敢用这么恐怖的东西😰，2022.2.22 注）</font> 去找了个号称 Android 7.1 的 ROM（上次刷机说是 9.0 实际上只有 6.0），由于不记得怎么用 TWRP 了就再去找了一遍，希望这次能够刷机顺利吧……</p>
<p>  附：<a target="_blank" rel="noopener" href="http://www.romleyuan.com/lec/read?id=111">TWRP使用教程</a></p>
<p>  刷入并安装 Flyme：</p>
<p><img src="%E5%88%B7%E5%85%A5Flyme.jpg" alt=""></p>
<p>  有过之前刷机的经验，刷入 Flyme 的过程还是很顺利地就完成了，稍等一会就进入到了系统的启动界面:</p>
<p><img src="%E5%90%AF%E5%8A%A8Flyme.png" alt="开机中...... 话说没开好机居然也能用scrcpy?"></p>
<p>  成功上车 Android 7.1.2 Flyme，测试看看效果怎么样，希望换 Flyme 之后 WebView 和 RootAutomator 能够不要再出问题</p>
<p><img src="%E5%85%B3%E4%BA%8E%E6%89%8B%E6%9C%BA.png" alt=""></p>
<p>  跟之前一样的操作，先把 Auto.js、MT 管理器 和 Xposed 框架装上：</p>
<p><img src="%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85.png" alt="下载安装文件"></p>
<p><img src="%E8%BF%9B%E5%BA%A6%E6%9D%A1.png" alt=""></p>
<p><img src="%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97.png" alt="下载所需模块 &amp; 城通网盘限我速"></p>
<p>  在启用模块的时候 Xposed Installer 报错，提示找不到文件，进入 MT 管理器查找对应目录，发现 conf 文件夹不存在，手动创建后报 <code>Permission denied</code>，卧槽？？？？</p>
<p><img src="Permission.png" alt=""></p>
<p>  淦，似乎在没有原官方 ROM 的情况下将 SuperSu 换成 Magisk 极其麻烦，白折腾几个小时，我还是换用太极吧（Root 用户用太极也太憋屈了吧）</p>
<p><img src="%E5%A4%AA%E6%9E%81.png" alt=""></p>
<p>  不过姑且还是把太极装上了，希望太极和 Root 不会冲突吧，装了 3 个模块，主要还是为了使用防撤回和签到文本化，打开 QQ 检查一下模块是否能用</p>
<p><img src="Module-1.png" alt=""></p>
<p><img src="Module-2.png" alt=""></p>
<p><img src="Module-3.png" alt=""></p>
<p><img src="Module-4.png" alt=""></p>
<p>  成功辣！！所有模块都能正常生效，换机的小插曲应该也能告一段落了吧，回头想想今天还是做了不少事情的，心里也是大大的舒畅，明天就可以开始正式编写脚本啦</p>
<h3 id="3-月-11-日">3 月 11 日</h3>
<p>  终于又可以继续写代码叻，尽管现在已经是半夜两点多钟，但还是完全没有困意，先把基本功能函数做好吧</p>
<ul>
<li>对 getMemberCount( ) 的修改</li>
</ul>
<p>  为提高效率，把获取通话人数、修正课程类型、修正课程标记、获取入口控件全部集成进去处理</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMemberCount</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>, view = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="literal">true</span>; i; i = <span class="literal">false</span>) {</span><br><span class="line">        <span class="keyword">var</span> title = textMatches(<span class="regexp">/语音通话中 \(\d+人\)/</span>).findOnce();</span><br><span class="line">        <span class="keyword">if</span> (title) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">            count = <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        title = textMatches(<span class="regexp">/\d+人正在语音通话/</span>).findOnce();</span><br><span class="line">        <span class="keyword">if</span> (title) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'share'</span>, viewing = <span class="literal">false</span>;</span><br><span class="line">            count = <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        title = text(<span class="string">'等待其他成员加入...'</span>).findOnce();</span><br><span class="line">        <span class="keyword">if</span> (title) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">            count = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        title = textMatches(<span class="regexp">/\d+人正在视频聊天/</span>).findOnce();</span><br><span class="line">        <span class="keyword">if</span> (title) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'live'</span>;</span><br><span class="line">            count = <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        title = textMatches(<span class="regexp">/\d+人正在通话/</span>).findOnce();</span><br><span class="line">        <span class="keyword">if</span> (title) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'live'</span>;  <span class="comment">// 两种方式同时存在时，优先选择群视频</span></span><br><span class="line">            count = <span class="built_in">parseInt</span>(title.text().match(<span class="regexp">/(\d+)人/</span>)[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> [count, view];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  这里用了一种非常规写法：创建一个只跑一次的 for 循环，并在判断语句内使用 break，可以有效避免使用过多 <code>if...else...</code> 结构，优化代码的执行效率和可读性</p>
<ul>
<li>rClick(view) &amp; pClick(view)</li>
</ul>
<p>  rClick 为递归点击，从 view 向上寻找到第一个可点击的父控件进行点击，pClick 为坐标点击，直接调用 Android 7.0+ 无障碍手势点击控件的坐标中心。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rClick</span>(<span class="params">view</span>) </span>{  <span class="comment">// 递归点击控件</span></span><br><span class="line">    <span class="keyword">return</span> view.clickable() ? view.click() : rClick(view.parent());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pClick</span>(<span class="params">view</span>) </span>{  <span class="comment">// 以坐标点击控件</span></span><br><span class="line">    <span class="keyword">var</span> bounds = view.bounds();</span><br><span class="line">    click(bounds.centerX(), bounds.centerY());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>jumpTo( ) 函数</li>
</ul>
<p>  通过 Intent（没错又是它）跳转到指定QQ群的资料卡，再用无障碍模拟点击「发消息」进入该群聊天界面</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jumpTo</span>(<span class="params">qid</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW, Uri.parse(</span><br><span class="line">        <span class="string">'mqqapi://card/show_pslcard?src_type=internal&amp;version=1&amp;card_type=group&amp;uin='</span> + qid</span><br><span class="line">    ));</span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">    context.startActivity(intent);</span><br><span class="line">    text(<span class="string">'发消息'</span>).findOne(<span class="number">3000</span>).click();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  忽然意思到一个较为棘手的问题，对于<strong>群课堂</strong>，无论自己是否在内，标题栏提示语都为同一格式，那么应该如何判断自己是否在内呢？</p>
<p>  想到的第一个方法是用 shell 命令动态更改 QQ 的悬浮窗权限，进入群课堂时打开悬浮窗权限，进入屏幕分享时禁用悬浮窗权限，结果查了查发现并不好操作。另一种可能可行的方案是通过 Root 权限直接启动系统设置的 Activity，再使用无障碍服务控制 QQ 的悬浮窗权限（不过这样搞真的稳定吗）</p>
<p><img src="%E5%83%B5%E5%B0%B8%E9%80%9A%E7%9F%A5.png" alt=""></p>
<p>  还想试试看能不能通过检测通知栏消息来判断课程状态，结果发现不管自己是否在课堂内，此通知都会显示在通知栏（而且不强制停止 QQ 还清不掉），看来这方法不可行。</p>
<p>  那有没有可能通过判断 QQ 媒体音量大小来判断自己是否位于直播间内呢？</p>
<p>  …貌似不行。</p>
<p>  不过在查找文档的过程中想到如果有类似网易云音乐的方式能够判断应用是否正在占用音频通道，不就能判断出自己是否位于直播间内了吗。</p>
<p>  emmmmmmm，这个方法即使可行，也违背了从简的初衷，我还是通过无障碍定时打开 QQ 悬浮窗权限吧：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置QQ悬浮窗权限，返回是否成功</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFloatyPermission</span>(<span class="params">flag</span>) </span>{</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">$</span>(<span class="params"></span>) </span>{</span><br><span class="line">        intent = <span class="keyword">new</span> Intent(<span class="string">"com.meizu.safe.security.SHOW_APPSEC"</span>);</span><br><span class="line">        intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">        intent.putExtra(<span class="string">"packageName"</span>, <span class="string">'com.tencent.mobileqq'</span>);</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">        <span class="keyword">var</span> button = desc(<span class="string">'悬浮窗,'</span>).findOne(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">if</span> (button) {</span><br><span class="line">            <span class="keyword">if</span> (flag) {</span><br><span class="line">                <span class="keyword">return</span> button.text() == <span class="string">'关闭'</span> &amp;&amp; button.click();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> button.text() == <span class="string">'开启'</span> &amp;&amp; button.click();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    $ = $();</span><br><span class="line">    sleep(<span class="number">1000</span>), back();</span><br><span class="line">    <span class="keyword">return</span> $;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  测试结果还是十分令人满意的，能够在两秒钟之内吧权限切换好，当然还需要导入两个类作为支持（群跳转、群签到、权限控制都要用到这两个类）：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">importClass(android.net.Uri);</span><br><span class="line">importClass(android.content.Intent);</span><br></pre></td></tr></tbody></table></figure>
<p><strong>下面插一些题外话</strong></p>
<p>  唔，看来还是不能啥都不挂直接睡啊，今天下午的这波生物课有点惊险了呢，明天上课的时候一定要记得把录音权限给了，不然听不到声音容易翻车啊。。。</p>
<div>
<a name="生物课-危"></a>
<img src="危3.png" style="margin-left:0;">
<img src="危4.png" style="margin-left:0;">
</div>
<p>  又是一波有惊无险……</p>
<h3 id="3-月-12-日">3 月 12 日</h3>
<p>  又拖了一天，真不知道在开学前能不能完成，加油继续写吧。。上次做了悬浮窗权限的控制，还差个能够检测悬浮窗是否存在的函数 <s>（有必要吗？直接关权限不行？不行，会陷入后台僵尸状态）</s></p>
<p>  忽然发现好像还能再做点优化：加入课堂之后不再使用无障碍 <code>back</code> 函数返回聊天界面，而是直接统一使用 <code>jumpTo</code> 函数直接跳转到聊天界面，相较原来的方法，便捷而且稳定。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (type) {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'live+'</span>:</span><br><span class="line">        pClick(text(<span class="string">'加入视频'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'live'</span>:</span><br><span class="line">        pClick(text(<span class="string">'加入本群房间'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br><span class="line">        <span class="keyword">if</span> (id(<span class="string">'chief_anchor_txt'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>)) {</span><br><span class="line">            jumpTo(classes[should]);</span><br><span class="line">            viewing = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'share'</span>:</span><br><span class="line">        pClick(text(<span class="string">'立即加入'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br><span class="line">        desc(<span class="string">'挂断'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>) &amp;&amp; (jumpTo(classes[should]), viewing = <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  又发现了新的问题，有时候「<strong>加入本群房间</strong>」按钮明明就在那里，可无障碍服务就是获取不到控件，极其依妖</p>
<p><img src="TypeError.png" alt=""></p>
<p>  仔细测试了一番，发现原来是因为进行 pClick 之前没有加延时，导致控件尚未变为可点击的状态就已经出发坐标点击，修改 pClick 函数后成功进入课堂</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pClick</span>(<span class="params">view, dalay</span>) </span>{  <span class="comment">// 以坐标点击控件</span></span><br><span class="line">    dalay &amp;&amp; sleep(dalay);</span><br><span class="line">    <span class="keyword">var</span> bounds = view.bounds();</span><br><span class="line">    click(bounds.centerX(), bounds.centerY());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  使用时传递 <code>delay</code> 参数：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pClick(text(<span class="string">'加入本群房间'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>  现在脚本已经具有最基本的上退课功能了(除了退出群课堂)，接下来将加入更为复杂的课内逻辑处理，包括入课冒泡、群签到打卡、问卷星打卡、复读机等高级功能的实现，同时也正在考虑加入定时截图的功能，以应对类似 <a href="./#%E7%94%9F%E7%89%A9%E8%AF%BE-%E5%8D%B1">3 月 11 日生物课</a> 的情况。</p>
<p>  刚刚在真实课堂测试的过程中发现了一个新的问题，在自己进入通话之后，当有人**进入或退出语音通话时，标题栏的文本会发生改变（群课堂的还没测试，目测应该不会）</p>
<p><img src="%E6%9C%89%E4%BA%BA%E8%BF%9B%E5%85%A5%E6%88%96%E9%80%80%E5%87%BA%E6%97%B6%E6%A0%87%E9%A2%98%E7%9A%84%E5%8F%98%E5%8C%96.png" alt=""></p>
<p>  给跳转课堂加上一个判断条件后解决：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找不到入口、应在上课、但没在上课</span></span><br><span class="line"><span class="keyword">if</span> (!tView &amp;&amp; ~should &amp;&amp; !viewing) {</span><br><span class="line">    jumpTo(classes[should]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  话说貌似可以顺便把每个人的去留情况也记录下来，做个教师助手之类的东西？<s>(做是不可能做的)</s></p>
<p>  为了保险起见，将留在课堂的人数下限更改为 25，其实最初也有想过通过检测人数的变化趋势来判断上下课，后来感觉算法不太好写，容易出岔子就放弃了，讲道理要是能够把算法和逻辑设计好的话应该是比现在的朴素判断方法更好的。</p>
<h3 id="3-月-13-日">3 月 13 日</h3>
<p>  今天先主要攻克复读机及其旗下方法，（貌似）在这台乐视手机上不会出现获取不到 view 的情况 <s>（顶多也就是点不到而已）</s>，于是直接使用 UICollection 的 findOne 方法寻找聊天记录</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> listView = id(<span class="string">'listView1'</span>).findOne(<span class="number">1000</span>).children(), list = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listView.length; i++) {</span><br><span class="line">    <span class="keyword">var</span> children = listView[i].children();</span><br><span class="line">    <span class="keyword">var</span> name = children.findOne(id(<span class="string">'chat_item_nick_name'</span>));</span><br><span class="line">    <span class="keyword">var</span> content = children.findOne(id(<span class="string">'chat_item_content_layout'</span>).className(<span class="string">'android.widget.TextView'</span>));</span><br><span class="line">    <span class="keyword">if</span> (name &amp;&amp; content) {</span><br><span class="line">        list.push([name, content]);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  能获取到聊天记录，不知道会不会隐藏着什么尚未出现的问题，而且当不在聊天界面时，findOne(1000) 就会返回 <code>null</code>，导致调用 children 方法时报错，添加限制条件后解决：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id(<span class="string">'rlCommenTitle'</span>).exists() &amp;&amp; repeat();</span><br></pre></td></tr></tbody></table></figure>
<p>  最近正好在研究 via 浏览器的插件脚本，用来屏蔽百度和 CSDN 的网页自动折叠，我不禁灵光一闪，想到可能可以借助 via 的插件功能实现问卷星的自动打卡功能，免去了自己开多线程写悬浮窗的麻烦 <s>，反正已经用 Xposed 了，再多个 via 也无所谓（其实是因为懒）</s></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wjxSign</span>(<span class="params">url</span>) </span>{  <span class="comment">// 问卷星打卡</span></span><br><span class="line">    <span class="comment">// **必须**保证Via浏览器为手机默认浏览器</span></span><br><span class="line">    app.openUrl(url);</span><br><span class="line">    desc(<span class="string">'提交成功！'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">    jumpTo(<span class="string">'105673***1'</span>);  <span class="comment">// 因为只有语文在问卷星打卡所以~</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  函数写起来还是很快的，简单三行就搞定了，不过要保证能用，就必须要保证 Via 为手机默认浏览器，且需要在 Via 中添加以下脚本：</p>
<p><img src="Via%E8%84%9A%E6%9C%AC.png" alt=""></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">    <span class="built_in">document</span>.getElementsByClassName(<span class="string">'jqradio'</span>)[<span class="number">0</span>].click();</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'q2'</span>).value = <span class="string">'49'</span>;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'q3'</span>).value = <span class="string">'【君の名は】'</span>;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'ctlNext'</span>).click();</span><br><span class="line">}, <span class="number">3000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>  接着在 getMemberCount 函数中增加了一段代码，用于判断是否存在群课堂的悬浮窗控件，从而判断自己是否在直播间内（其实这个两天前就应该做了，一直拖到现在才搞）</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (type == <span class="string">'live'</span>) {</span><br><span class="line">    <span class="keyword">var</span> roots = auto.windowRoots;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; roots.length; i++) {</span><br><span class="line">        <span class="keyword">if</span> (roots[i].packageName() == <span class="string">''</span> &amp;&amp; roots[i].clickable()) {</span><br><span class="line">            viewing = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    viewing = <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  继续测试，然后发现当悬浮窗存在时，只能点击悬浮窗右上角的 <code>x</code> 才能正常退出直播间，于是安排上了新的代码：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">auto.setWindowFilter(<span class="function">(<span class="params">win</span>) =&gt;</span> {<span class="keyword">return</span> <span class="literal">true</span>;});</span><br><span class="line"><span class="keyword">var</span> roots = auto.windowRoots;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; roots.length; i++) {</span><br><span class="line">  <span class="keyword">if</span> (roots[i].packageName() == qqpkg &amp;&amp; roots[i].clickable()) {</span><br><span class="line">      pClick(roots[i].child(<span class="number">0</span>).child(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">auto.setWindowFilter(<span class="function">(<span class="params">win</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> win.type == <span class="string">'TYPE_APPLICATION'</span>;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>  刚刚在读取消息记录的部分把问卷星打卡也加入了：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">url</span>) </span>{</span><br><span class="line">    url &amp;&amp; wjxSign(url);</span><br><span class="line">})(list[i][<span class="number">1</span>].match(<span class="regexp">/https?:\/\/www\.wjx\.cn\/[A-Za-z0-9/]+\.aspx?/</span>));</span><br></pre></td></tr></tbody></table></figure>
<p>  严格来说，现在已经是 3 月 14 日凌晨四点了，困得一批，可能写出来的东西会有点混乱，再写估计就要语无伦次了，今天就先到这里吧。</p>
<p>  待我把 Auto.js 的权限和 QQ 登录状况检查一遍，确保明天早上的两个自动脚本能够顺利运行，没发现什么问题就睡啦</p>
<h3 id="3-月-14-日">3 月 14 日</h3>
<p>  很难受，今天早上起来，直接挂机睡觉了，结果因为老脚本中的 now 变量没有替换成 getTime() 函数，导致进入下课逻辑的时候报找不到 now 变量（这波危），看来还是我对脚本太自信了</p>
<p><img src="%E6%89%BE%E4%B8%8D%E5%88%B0now.png" alt=""></p>
<p>  下午测试，发现下课逻辑处理不当，导致脚本发生鬼畜，其原因是对等待逻辑的处理有问题，原逻辑是「如果没有发现“谢谢老师”，且 15 分钟前不应该上课，则直接退出」，测试的时候发现这脚本会在上课的前 15 分钟发生鬼畜，反复进退，现将逻辑更改为「如果没有发现“谢谢老师”，且 15 分钟前和现在都不在上课时间，则直接退出」，问题得到解决</p>
<p>  现在的 Qlivoid++ 还没有像旧版一样的震动提醒功能，我打算在这一版中优化震动提醒的功能，使用频率的变化来体现不同的重要程度，并同时支持调节时间长短的功能：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notify</span>(<span class="params">importance, time</span>) </span>{</span><br><span class="line">    time = time || <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">var</span> cycle = <span class="number">130</span> - importance*<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="string">'- '</span>.repeat((time/cycle)|<span class="number">0</span>) + <span class="string">'-'</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; msg.length; i++) {</span><br><span class="line">        msg[i] == <span class="string">'-'</span> &amp;&amp; device.vibrate(cycle);</span><br><span class="line">        sleep(cycle+<span class="number">5</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  这就是新的消息通知函数，支持频率级别 0 ~ 9，震动时间可调，默认 500 ms</p>
<p>  下一步准备对 getMemberCount 函数再做一次优化，使用正则表达式匹配标题文字，减少搜索控件的次数，其实最终目的还是为了提高获取聊天记录的效率，全力辅助复读机（这复读机还真是麻烦，逻辑十分复杂）。以及进一步增加当直播出现故障时重启 QQ 的功能</p>
<h3 id="3-月-15-日">3 月 15 日</h3>
<p>  昨天有些事忙去了，就没写多少代码，今天打算先把比较简单的入课打卡功能先做了，然后再整理一波复读机的逻辑</p>
<p>  入课冒泡函数整理如下：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> signText = [<span class="string">'1'</span>, <span class="string">'#sign#'</span>, <span class="string">'.'</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bubble</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> time = getTime();</span><br><span class="line">    <span class="keyword">if</span> (~shouldInWhat(time+<span class="number">5</span>) &amp;&amp; !~shouldInWhat(time-<span class="number">7</span>)) {</span><br><span class="line">        <span class="keyword">var</span> msg = signText[(random()*signText.length)|<span class="number">0</span>];</span><br><span class="line">        msg == <span class="string">'#sign#'</span> ?  qciSign(shouldInWhat(getTime())) : sendMessage(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  其中涉及到的 sendMessage 函数：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params">msg</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> editText = id(<span class="string">'input'</span>).findOne(<span class="number">3000</span>);</span><br><span class="line">    <span class="keyword">if</span> (editText) {</span><br><span class="line">        editText.setText(msg);</span><br><span class="line">        id(<span class="string">'fun_btn'</span>).findOne(<span class="number">3000</span>).click();;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'自动发送了消息，注意安全。'</span>);</span><br><span class="line">        notify(<span class="number">3</span>, <span class="number">150</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  然后补上昨天的 GetMemberCount 函数升级版，使用字符串处理代替了多次寻找控件，使函数耗时从 1.2s 缩短到小于 400ms</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMemberCount</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>, view = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> title = textMatches(<span class="regexp">/(?:语音通话中 \()?\d+\+?人\)?(?:正在(?:(?:语音)?通话|视频聊天))?|等待其他成员加入\.\.\./</span>).findOne(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (title) {</span><br><span class="line">        <span class="keyword">var</span> tText = title.text();</span><br><span class="line">        <span class="keyword">var</span> population = tText.match(<span class="regexp">/(\d+)\+?人/</span>);</span><br><span class="line">        population &amp;&amp; (count = <span class="built_in">parseInt</span>(population[<span class="number">1</span>]));</span><br><span class="line">        <span class="keyword">if</span> (tText.match(<span class="regexp">/语音通话中 \(\d+\+?人\)/</span>)) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (tText.match(<span class="regexp">/\d+\+?人正在语音通话/</span>)) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'share'</span>, viewing = <span class="literal">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (tText == <span class="string">'等待其他成员加入...'</span>) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">            count = <span class="number">1</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (tText.match(<span class="regexp">/\d+\+?人正在视频聊天/</span>)) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'live'</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (tText.match(<span class="regexp">/\d+\+?人正在通话/</span>)) {</span><br><span class="line">            view = title;</span><br><span class="line">            type = <span class="string">'live+'</span>;  <span class="comment">// 两种方式同时存在时，优先选择群视频</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 通过检测悬浮窗状态判断是否位于课堂内</span></span><br><span class="line">    <span class="keyword">if</span> (type == <span class="string">'live'</span>) {</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">$</span>(<span class="params"></span>) </span>{</span><br><span class="line">            auto.setWindowFilter(<span class="function">() =&gt;</span> {<span class="keyword">return</span> <span class="literal">true</span>;});</span><br><span class="line">            <span class="keyword">var</span> roots = auto.windowRoots;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; roots.length; i++) {</span><br><span class="line">                <span class="keyword">if</span> (roots[i].packageName() == qqpkg &amp;&amp; roots[i].clickable()) {</span><br><span class="line">                    viewing = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            viewing = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        $();</span><br><span class="line">        auto.setWindowFilter(<span class="function">(<span class="params">win</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">return</span> win.type == <span class="string">'TYPE_APPLICATION'</span>;</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> [count, view];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  关于复读机的逻辑，首先必须保证，复读机不能瞎说话，也不能等待很久后才复读说话，必须具有及时性，其次又不能过于自闭，要有一定的活跃度，这样复读机才有其存在的意义</p>
<p>  首先为了安全考虑，长度大于 5 的消息不会被脚本复读，当屏幕上有自己的消息存在时也不会触发复读，上次复读过的消息也不会被复读（这里的「上次」应该有一个判定机制，如经过一段时间后就不再认为是「上次」），同时注意区分大小写，避免诸如「A」 和「a」被复读两次的情况发生，应有一个算法，对消息进行处理，保证复读内容的有效，准确。</p>
<h3 id="3-月-16-日">3 月 16 日</h3>
<p>  发现了一个恶性 bug，如果反复调用 <code>auto.setWindowFilter()</code> 函数，很容易出现获取不到控件的情况，于是为了稳定性考虑，不得已牺牲一些效率，将窗口过滤器设置成全局模式</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto.setWindowFilter(<span class="function">() =&gt;</span> {<span class="keyword">return</span> <span class="literal">true</span>;});</span><br></pre></td></tr></tbody></table></figure>
<p>  新问题，当群课堂结束以后，悬浮窗文字会变为「<strong>等待中</strong>」，此时标题栏消失，未能正常退出直播间，通过在 getMemberCount 函数末尾对悬浮窗的判定中增加一小段代码解决，当检测到悬浮窗显示的字样变为「等待中」时，启用坐标点击悬浮窗右上角的「<code>×</code>」关闭悬浮窗。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chFlag = type.startsWith(<span class="string">'live'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> roots = auto.windowRoots;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; roots.length; i++) {</span><br><span class="line">        <span class="keyword">if</span> (roots[i].packageName() == qqpkg &amp;&amp; roots[i].clickable()) {</span><br><span class="line">            <span class="keyword">if</span> (roots[i].children().findOne(text(<span class="string">'等待中'</span>))) {</span><br><span class="line">                <span class="built_in">console</span>.log();</span><br><span class="line">                pClick(roots[i].child(<span class="number">0</span>).child(<span class="number">1</span>));</span><br><span class="line">            }</span><br><span class="line">            chFlag &amp;&amp; (viewing = <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    chFlag &amp;&amp; (viewing = <span class="literal">false</span>);</span><br><span class="line">}</span><br><span class="line">$();</span><br></pre></td></tr></tbody></table></figure>
<p>  改完顺手优化了下 reset 函数中对于 QQ 出现异常情况的判定，这样写或许会快一些吧。。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (id(<span class="string">'graybar'</span>).textMatches(<span class="regexp">/加入语音通话失败|网络异常.*/</span>).exists()) {</span><br><span class="line">    restartQQ();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  后续可能会考虑继续加入屏幕日志功能，毕竟没连接电脑的时候看日志很不方便。而且听说开学时间延后到 4 月初了？从现在的进度看来脚本应该能够在开学之前完成，这段时间为了写脚本确实有点太拼了，睡眠不够状态也不太好，今天就先睡个午觉吧（虽然不懂这一觉会睡到几点钟），话说明天就是 Qlivoid 正式开发一个月了呢，时间过得还真快啊。</p>
<p>  下午化学课继续测试，发现有时候 QQ 的权限会「耍流氓」，在已经禁用悬浮窗权限的情况下依然显示悬浮窗，在代码中加入了一行，使脚本子在每次修改权限的时候至少拨动一次按钮，不知道能否解决问题：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFloatyPermission</span>(<span class="params">flag</span>) </span>{</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">$</span>(<span class="params"></span>) </span>{</span><br><span class="line">        intent = <span class="keyword">new</span> Intent(<span class="string">"com.meizu.safe.security.SHOW_APPSEC"</span>);</span><br><span class="line">        intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">        intent.putExtra(<span class="string">"packageName"</span>, qqpkg);</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">        <span class="keyword">var</span> button = desc(<span class="string">'悬浮窗,'</span>).findOne(<span class="number">2000</span>);</span><br><span class="line">        button.click();</span><br><span class="line">        sleep(<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">if</span> (button) {</span><br><span class="line">            <span class="keyword">if</span> (flag) {</span><br><span class="line">                <span class="keyword">return</span> button.text() == <span class="string">'开启'</span> &amp;&amp; button.click();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> button.text() == <span class="string">'关闭'</span> &amp;&amp; button.click();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    $ = $();</span><br><span class="line">    sleep(<span class="number">800</span>), back();</span><br><span class="line">    <span class="keyword">return</span> $;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  一定要注意这里「开启」和「关闭」的判定要反过来（因为之前点过一次按钮），不然就会授权出错，该给的时候没给，不该给的时候却又给权限。</p>
<p>  接着直接从旧版 Qlivoid 中复制关于屏幕日志的部分（这部分没怎么问题，不改也能正常使用）：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">screenLog</span>(<span class="params"></span>) </span>{  <span class="comment">// 启动悬浮窗，将日志显示在屏幕上</span></span><br><span class="line">    <span class="keyword">var</span> w = floaty.rawWindow(</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">vertical</span> <span class="attr">bg</span>=<span class="string">'#10000000'</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">com.stardust.autojs.core.console.ConsoleView</span> <span class="attr">id</span>=<span class="string">'ConS'</span> <span class="attr">margin</span>=<span class="string">'30'</span>/&gt;</span>    </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">vertical</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">    w.setSize(-<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    w.setTouchable(<span class="literal">false</span>);</span><br><span class="line">    ui.run(<span class="function">() =&gt;</span> {</span><br><span class="line">        w.ConS.setConsole(org.autojs.autojs.autojs.AutoJs.getInstance().getGlobalConsole());</span><br><span class="line">        w.ConS.findViewById(<span class="number">213129</span>***<span class="number">3</span>).setVisibility(android.view.View.GONE);</span><br><span class="line">    });    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  下一步准备加入类似旧版的每隔一定周期日志提醒的功能，还可以顺便将复读机的重置器也添加进去。</p>
<p>  ……出现了严重的 bug，这脚本到上课时间居然不会自己切换群聊，检查了一下发现是由于界面刷新导致之前获取的 View 无效的问题，无奈之下只能再次牺牲效率，增加一次对控件的搜索，下面是再次修改过的 getMemberCount 函数片段：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>, tType = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">var</span> title = textMatches(<span class="regexp">/(?:语音通话中 \()?\d+\+?人\)?(?:正在(?:(?:语音)?通话|视频聊天))?|等待其他成员加入\.\.\.|.+(加入|退出)了.+/</span>).findOne(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">if</span> (title) {</span><br><span class="line">    <span class="keyword">var</span> tText = title.text();</span><br><span class="line">    <span class="keyword">var</span> population = tText.match(<span class="regexp">/(\d+)\+?人/</span>);</span><br><span class="line">    population &amp;&amp; (count = <span class="built_in">parseInt</span>(population[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">if</span> (tText.match(<span class="regexp">/语音通话中 \(\d+\+?人\)/</span>)) {</span><br><span class="line">        tType = <span class="string">'语音通话中'</span>;</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (tText.match(<span class="regexp">/\d+\+?人正在语音通话/</span>)) {</span><br><span class="line">        tType = <span class="string">'人正在语音通话'</span>;</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">false</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (tText == <span class="string">'等待其他成员加入...'</span>) {</span><br><span class="line">        tType = <span class="string">'等待其他成员加入'</span>;</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">        count = <span class="number">1</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (tText.match(<span class="regexp">/\d+\+?人正在视频聊天/</span>)) {</span><br><span class="line">        tType = <span class="string">'人正在视频聊天'</span>;</span><br><span class="line">        type = <span class="string">'live'</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (tText.match(<span class="regexp">/\d+\+?人正在通话/</span>)) {</span><br><span class="line">        tType = <span class="string">'人正在通话'</span>;</span><br><span class="line">        type = <span class="string">'live+'</span>;  <span class="comment">// 两种方式同时存在时，优先选择群视频</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (~tText.search(<span class="regexp">/(?:加入|退出)了/</span>)) {</span><br><span class="line">        tType = <span class="string">'#'</span>;</span><br><span class="line">        type = <span class="string">'share'</span>, viewing = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  将原来的获取控件改成了获取文本，界面切换后再通过文本获取控件，同时修改了正则表达式，使其能够匹配有人加入或退出时的提示，同样对主循环也做了一些修改，使其适应现在的 GerMemberCount 函数，修改后的主循环如下：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        reset();</span><br><span class="line">        <span class="keyword">var</span> should = shouldInWhat(getTime());</span><br><span class="line">        <span class="keyword">if</span> (id(<span class="string">'rlCommenTitle'</span>).exists()) {</span><br><span class="line">            repeat();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">var</span> pair = getMemberCount();  <span class="comment">// 同时获取人数和入口view</span></span><br><span class="line">        <span class="keyword">var</span> mCount = pair[<span class="number">0</span>], tType = pair[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> ((~should &amp;&amp; !viewing) || !tType) {  <span class="comment">// 应在上课、没在上课 或 找不到标题</span></span><br><span class="line">            jumpTo(classes[should]);</span><br><span class="line">            sleep(<span class="number">2000</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (mCount) {</span><br><span class="line">            <span class="keyword">if</span> (~should &amp;&amp; mCount &gt;= <span class="number">40</span> &amp;&amp; !viewing) {  <span class="comment">// 应在上课、没在上课、人数&gt;=40</span></span><br><span class="line">                notify(<span class="number">3</span>, <span class="number">150</span>), <span class="built_in">console</span>.log(<span class="string">'发现课程，即将加入'</span>);</span><br><span class="line">                setFloatyPermission(type.startsWith(<span class="string">'live'</span>)), sleep(<span class="number">2000</span>);</span><br><span class="line">                rClick(textContains(tType).findOne(<span class="number">100</span>));</span><br><span class="line">                <span class="keyword">switch</span> (type) {</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'live+'</span>:</span><br><span class="line">                        pClick(text(<span class="string">'加入视频'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'live'</span>:</span><br><span class="line">                        pClick(text(<span class="string">'加入本群房间'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br><span class="line">                        <span class="keyword">if</span> (id(<span class="string">'chief_anchor_txt'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>)) {</span><br><span class="line">                            jumpTo(classes[should]);</span><br><span class="line">                            viewing = <span class="literal">true</span>;</span><br><span class="line">                            sleep(<span class="number">2000</span>), bubble();</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'share'</span>:</span><br><span class="line">                        pClick(text(<span class="string">'立即加入'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>), <span class="number">500</span>);</span><br><span class="line">                        desc(<span class="string">'挂断'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>) &amp;&amp; (jumpTo(classes[should]), viewing = <span class="literal">true</span>);</span><br><span class="line">                        sleep(<span class="number">2000</span>), bubble();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">var</span> forcedExit = !~shouldInWhat(getTime()-<span class="number">15</span>) &amp;&amp; !~shouldInWhat(getTime());</span><br><span class="line">            <span class="keyword">if</span> (viewing &amp;&amp; (mCount &lt; <span class="number">25</span> || exitConfirm || forcedExit)) {</span><br><span class="line">                notify(<span class="number">3</span>, <span class="number">150</span>), <span class="built_in">console</span>.log(<span class="string">'进入下课逻辑'</span>);</span><br><span class="line">                <span class="keyword">switch</span> (type) {</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'live+'</span>:</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'live'</span>:</span><br><span class="line">                        <span class="keyword">var</span> roots = auto.windowRoots;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; roots.length; i++) {</span><br><span class="line">                            <span class="keyword">if</span> (roots[i].packageName() == qqpkg &amp;&amp; roots[i].clickable()) {</span><br><span class="line">                                pClick(roots[i].child(<span class="number">0</span>).child(<span class="number">1</span>));</span><br><span class="line">                                viewing = <span class="literal">false</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'share'</span>:</span><br><span class="line">                        rClick(textContains(tType).findOne(<span class="number">100</span>));</span><br><span class="line">                        desc(<span class="string">'挂断'</span>).findOne(<span class="number">10</span>*<span class="number">1000</span>).click();</span><br><span class="line">                        viewing = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span>(e) {</span><br><span class="line">        <span class="keyword">var</span> line = e.stack.split(<span class="string">'\n'</span>)[<span class="number">0</span>].match(<span class="regexp">/\t.+:(\d+)/</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">'错误拦截: At line:'</span> + line + <span class="string">' '</span> + e);</span><br><span class="line">        notify(<span class="number">6</span>, <span class="number">200</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>  每隔 5 分钟脚本应把 viewing 设置为 <code>false</code>，避免获取不到 view 时不上课的情况，可以增加脚本的稳定性和安全性</p>
<h3 id="3-月-17-日">3 月 17 日</h3>
<p>  犹豫了下决定加入脚本暂停功能，使得脚本能够在运时可控地暂停，方便紧急时的处理和调试，暂停过程中每隔 5s 发送一次震动提醒，代码比较简单，就只有一个悬浮窗和一个死循环，这里就不放出来了。</p>
<p><img src="%E8%84%9A%E6%9C%AC%E6%9A%82%E5%81%9C.png" alt=""></p>
<p>  忽略掉乱七八糟的报错，屏幕中间那个写着「✔」的悬浮窗，就是脚本暂停的控制开关，脚本在执行完一个循环后，如果发现设置暂停的变量为 <code>true</code>，就会进入死循环，直到变量值变为 <code>false</code></p>
<p>  此外随着脚本逻辑越来越复杂，可能以后那些比较复杂的机制，都不太方便把代码直接放出来，可能会转为以图片为主的记录模式</p>
<p>  终于正式进入复读的开发了吗？先把逻辑整理清楚，接着上次的分析，长度过大的消息不会被复读，一定时间内复读过的消息不会被再次复读；每隔 40s 向前滚动一次「<strong>发送过的消息</strong>」列表，列表长度为 3，即三次内发送过的消息不会被再次复读；如果获取到的消息全部由数字和字母组成，且长度<strong>不为</strong> 1，则全部转为小写，若长度<strong>为</strong>  1，则转为大写，这样一来就能较好的适应各科的发言情况了。每次复读之后都会有 20s 的冷却时间，冷却时间内不会复读任何消息（但依然会记录，只是不读而已），因为有可能会出现复读完成后侧循环刚好完成的情况，复读的冷却要在主循环中进行。</p>
<p><img src="%E5%A4%8D%E8%AF%BB%E6%9C%BA.png" alt=""></p>
<p>  复读机完成，能够正常复读，明天继续测试看看还有没有 bug，至此四大金刚函数全部完成，准备将脚本正式投入使用。</p>
<h3 id="3-月-19-日">3 月 19 日</h3>
<p>  收到了确切的消息，开学时间是 4 月 7 日，这意味着 Qlivoid++ 还能使用很长的一段时间，在前两日的使用中，当然也发现了一些 bug，其中大部分都已修复，有一些比较棘手的 bug 和待优化的地方我将写在下面，然后一一修复。由于时间关系，修复的过程和具体细节我就不在此具体列出了，当前存在的问题如下：</p>
<ul>
<li>✅ 发送消息后没有自动关闭键盘</li>
<li>✅ 进入课堂时如果正在通话会进入失败</li>
<li>❎ 重启QQ后scheme失效 <font size="2" color="gray">（这应该不是我能解决的问题吧）</font></li>
</ul>
<h2 id="写在最后">写在最后</h2>
<p>  随着第一条复读消息的发出，Qlivoid++ 的开发也算是告一段落，从 2 月 16 日到 3 月 17 日，历时一个月的开发，说长不长，说短也不短。但从中，我学到了很多新的语法，也更加深入地了解了 JavaScript 的运行机制，同时对自动化测试也有了一个更深的认识，在这一个月的时间里，我遇到过很多的问题，<strong>尝试-错误-Debug-再尝试</strong>，循环往复已不知几轮，但最终，当 Qlivoid++ 在我面前稳定地运行的那一刻，我终于露出了欣慰的笑容。</p>
<p>  最终便只剩下了一些收尾工作，比如更加合理地安排日志输出，使脚本更加易于使用，如果还有 bug，我也会继续修复，总之这次的项目，真的让我受益匪浅。</p>
<h2 id="Q-A（2022-新增）">Q &amp; A（2022 新增）</h2>
<ul>
<li>Q：大二的你，再回头看 Qlivoid 时，有什么感想？</li>
</ul>
<blockquote>
<p>  A：仅仅靠这些“破铜烂铁”，能花一个月时间将能用的脚本肝出来，还真是一个奇迹。现在的我，虽然技术上有所长进，但跟高中比起来，却少了那一份坚持，也许这就是我该改进的地方罢</p>
</blockquote>
<ul>
<li>Q：如果以你现在掌握的技术，穿越回到高中时代，会如何实现 Qlivoid？</li>
</ul>
<blockquote>
<p>  A：大概是 go-cqhttp 和 Xposed 模块的组合，模块仅用于处理进入/退出课堂，复读机等功能全部交由 Python 后端完成，至于模块与后端的通信，采用本地 Unix Socket 即可</p>
</blockquote>
<!-- hexo injector body_end start --><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.js"></script><script async src="https://at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Mufanc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.mufanc.xyz/posts/25707/">https://blog.mufanc.xyz/posts/25707/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明文章出处！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/assets/images/top_img.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/posts/69006241/"><img class="prev-cover" src="/assets/images/top_img.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">简单神经网络之验证码识别</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/assets/images/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mufanc</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Mufanc"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">&emsp;分类和标签有点乱了，得找时间重新规划一下🤔
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E5%BF%86%E9%83%A8%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text">回忆部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%88-16-%E6%97%A5-%E5%BC%80%E7%AB%AF"><span class="toc-number">2.1.</span> <span class="toc-text">2 月 16 日 开端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%88-20-%E6%97%A5-%E9%9B%8F%E5%BD%A2"><span class="toc-number">2.2.</span> <span class="toc-text">2 月 20 日 雏形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%88-28-%E6%97%A5-%E6%9B%B4%E6%96%B0"><span class="toc-number">2.3.</span> <span class="toc-text">2 月 28 日 更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%88-29-%E6%97%A5-%E6%9B%B4%E6%96%B0"><span class="toc-number">2.4.</span> <span class="toc-text">2 月 29 日 更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-3-%E6%97%A5-%E6%9B%B4%E6%96%B0"><span class="toc-number">2.5.</span> <span class="toc-text">3 月 3 日 更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-5-%E6%97%A5-%E5%A4%A7%E6%9B%B4%E6%96%B0"><span class="toc-number">2.6.</span> <span class="toc-text">3 月 5 日 大更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-7-%E6%97%A5-%E6%9B%B4%E6%96%B0"><span class="toc-number">2.7.</span> <span class="toc-text">3 月 7 日 更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%BC%8F%E8%AE%B0%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">正式记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%87%A0%E7%82%B9"><span class="toc-number">3.1.</span> <span class="toc-text">需要注意的几点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%82%AC%E6%B5%AE%E7%AA%97%E6%9D%83%E9%99%90%E6%9C%AA%E8%83%BD%E8%8E%B7%E5%8F%96"><span class="toc-number">3.1.1.</span> <span class="toc-text">悬浮窗权限未能获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E5%8A%A0%E5%85%A5%E9%80%9A%E8%AF%9D"><span class="toc-number">3.1.2.</span> <span class="toc-text">提示加入通话</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E6%B7%BB%E5%8A%A0%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.3.</span> <span class="toc-text">提示添加快捷方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E9%80%9A%E8%AF%9D%E5%86%B2%E7%AA%81"><span class="toc-number">3.1.4.</span> <span class="toc-text">提示通话冲突</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E6%82%AC%E6%B5%AE%E7%AA%97%E6%89%93%E5%BC%80%E5%A4%B1%E8%B4%A5"><span class="toc-number">3.1.5.</span> <span class="toc-text">提示悬浮窗打开失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BE%A4%E5%85%AC%E5%91%8A"><span class="toc-number">3.1.6.</span> <span class="toc-text">群公告</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7"><span class="toc-number">3.2.</span> <span class="toc-text">一些奇技淫巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-9-%E6%97%A5"><span class="toc-number">3.3.</span> <span class="toc-text">3 月 9 日</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#QQ%E7%94%B5%E8%AF%9D%E3%80%81%E5%B1%8F%E5%B9%95%E5%88%86%E4%BA%AB"><span class="toc-number">3.3.1.</span> <span class="toc-text">QQ电话、屏幕分享</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BE%A4%E8%A7%86%E9%A2%91%E3%80%81%E7%BE%A4%E8%AF%BE%E5%A0%82"><span class="toc-number">3.3.2.</span> <span class="toc-text">群视频、群课堂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5"><span class="toc-number">3.3.3.</span> <span class="toc-text">特殊情况</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-10-%E6%97%A5"><span class="toc-number">3.4.</span> <span class="toc-text">3 月 10 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-11-%E6%97%A5"><span class="toc-number">3.5.</span> <span class="toc-text">3 月 11 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-12-%E6%97%A5"><span class="toc-number">3.6.</span> <span class="toc-text">3 月 12 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-13-%E6%97%A5"><span class="toc-number">3.7.</span> <span class="toc-text">3 月 13 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-14-%E6%97%A5"><span class="toc-number">3.8.</span> <span class="toc-text">3 月 14 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-15-%E6%97%A5"><span class="toc-number">3.9.</span> <span class="toc-text">3 月 15 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-16-%E6%97%A5"><span class="toc-number">3.10.</span> <span class="toc-text">3 月 16 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-17-%E6%97%A5"><span class="toc-number">3.11.</span> <span class="toc-text">3 月 17 日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%88-19-%E6%97%A5"><span class="toc-number">3.12.</span> <span class="toc-text">3 月 19 日</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">4.</span> <span class="toc-text">写在最后</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q-A%EF%BC%882022-%E6%96%B0%E5%A2%9E%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">Q &amp; A（2022 新增）</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/1577788855/" title="Android 应用启动流程分析（持续更新）">Android 应用启动流程分析（持续更新）</a><time datetime="2022-09-18T07:07:30.000Z" title="发表于 2022-09-18 15:07:30">2022-09-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/73251555/" title="在 Linux 上游玩原神（国服）">在 Linux 上游玩原神（国服）</a><time datetime="2022-08-24T15:30:31.000Z" title="发表于 2022-08-24 23:30:31">2022-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/1719361358/" title="绕过 Shamiko v0.5.2 检测 Zygisk">绕过 Shamiko v0.5.2 检测 Zygisk</a><time datetime="2022-07-26T18:32:32.000Z" title="发表于 2022-07-27 02:32:32">2022-07-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4104300991/" title="理解 Linux 的「挂载命名空间」机制">理解 Linux 的「挂载命名空间」机制</a><time datetime="2022-07-05T18:14:49.000Z" title="发表于 2022-07-06 02:14:49">2022-07-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/2752488453/" title="基于内存搜索的 Zygisk 注入检测方案">基于内存搜索的 Zygisk 注入检测方案</a><time datetime="2022-06-28T14:26:37.000Z" title="发表于 2022-06-28 22:26:37">2022-06-28</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Mufanc</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://hexo-twikoo-eight.vercel.app/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.vemoji)'))
      }
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://hexo-twikoo-eight.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      document.getElementById('twikoo-count').innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="/assets/js/register-sw.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>